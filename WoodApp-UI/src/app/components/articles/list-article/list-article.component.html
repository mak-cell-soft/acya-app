<h4>Liste des Articles</h4>
<!-- Add this progress bar at the top of the page -->
<mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>
<div class="search">
  <div class="search-bar-container">
    <button mat-icon-button>
      <mat-icon>
        search
      </mat-icon>
    </button>
    <input (keyup)="applyFilter($event)" placeholder="Rechercher dans les articles" #input />
  </div>
  <div class="button-container">
    <mat-dialog-actions>
      <button mat-flat-button color="primary" [routerLink]="['add']">
        <!-- <button mat-flat-button color="primary" (click)="OpenDialogAddArticle()"> -->
        <mat-icon>
          add
        </mat-icon>
        Ajouter
      </button>
    </mat-dialog-actions>
  </div>
</div>

<!-- Table List Articles -->
<div class="table-container mat-elevation-z8">
  <table mat-table [dataSource]="allArticles" matSort class="article-table" *ngIf="allArticles.data?.length"
    multiTemplateDataRows>

    <!-- rowIndex Column -->
    <!-- <ng-container matColumnDef="rowIndex">
      <th mat-header-cell *matHeaderCellDef> No. </th>
      <td mat-cell *matCellDef="let element; let i = index;"> {{i + 1}} </td>
    </ng-container> -->

    <!-- Reference Column -->
    <ng-container matColumnDef="reference">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="article-table-cell reference-column"> Référence </th>
      <td mat-cell *matCellDef="let element" class="article-table-cell reference-column"> {{element.reference}} </td>
    </ng-container>

    <!-- Description Column -->
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="article-table-cell description-column"> Description
      </th>
      <td mat-cell *matCellDef="let element" class="article-table-cell description-column"> {{element.description}}
      </td>
    </ng-container>

    <!-- Category Column -->
    <ng-container matColumnDef="category">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="article-table-cell"> Catégorie </th>
      <td mat-cell *matCellDef="let element" class="article-table-cell"> {{element.category.description}} </td>
    </ng-container>

    <!-- SubCategory Column -->
    <ng-container matColumnDef="subcategory">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="article-table-cell"> Sous Catégory </th>
      <td mat-cell *matCellDef="let element" class="article-table-cell"> {{element.subcategory.description}} </td>
    </ng-container>

    <!-- Sell Price Column -->
    <ng-container matColumnDef="sellprice_ttc">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="article-table-cell"> Vente TTC </th>
      <td mat-cell *matCellDef="let element" class="article-table-cell"> {{element.sellprice_ttc | number:'1.3-3'}}
      </td>
    </ng-container>

    <!-- TVA Column -->
    <ng-container matColumnDef="tva">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="article-table-cell"> TVA</th>
      <td mat-cell *matCellDef="let element" class="article-table-cell"> {{element.tva.value}} </td>
    </ng-container>

    <!-- Sell Price HT Column -->
    <ng-container matColumnDef="sellprice_ht">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="article-table-cell"> Vente HT </th>
      <td mat-cell *matCellDef="let element" class="article-table-cell"> {{element.sellprice_ht | number:'1.3-3'}} </td>
    </ng-container>

    <!-- Creation date Column -->
    <ng-container matColumnDef="creationdate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="article-table-cell"> Date de création </th>
      <td mat-cell *matCellDef="let element" class="article-table-cell"> {{element.creationdate | date: 'dd-MM-yyyy'}}
      </td>
    </ng-container>

    <!-- Action Column -->
    <ng-container matColumnDef="action">
      <th mat-header-cell *matHeaderCellDef> action </th>
      <td mat-cell style="white-space: pre-line" *matCellDef="let element">
        <mat-icon *ngIf="!element.editing" class="green-icon" (click)="editArticle(element)">edit</mat-icon>
        <mat-icon *ngIf="element.editing" class="red-icon" (click)="cancelEditArticle(element)">cancel</mat-icon>
        <mat-icon class="red-icon" (click)="deleteArticle(element)">delete</mat-icon>
      </td>
    </ng-container>

    <!-- Expanded Element-->
    <ng-container matColumnDef="expand">
      <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
      <td mat-cell *matCellDef="let element">
        <button mat-icon-button aria-label="expand row"
          (click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation()">
          <mat-icon>{{expandedElement === element ? 'keyboard_arrow_up' : 'keyboard_arrow_down'}}</mat-icon>
        </button>
      </td>
    </ng-container>

    <!-- Expanded Content Column - Detail row for additional properties -->
    <ng-container matColumnDef="expandedDetail">
      <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplayWithExpand.length-1">
        <div class="example-element-detail" [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
          <!-- Display the desired additional fields from Article model -->
          <div *ngIf="element.iswood === true">
            <div><strong>Epaisseur (m) : &nbsp;</strong> {{element.thickness?.value || '--'}} &nbsp;&nbsp;</div>
            <div><strong>Largeur (m) : &nbsp;</strong> {{element.width?.value || '--'}} &nbsp;&nbsp;</div>
            <div><strong>Liste des Longueurs (cm) : &nbsp;</strong> {{element.lengths || '--'}} &nbsp;&nbsp;</div>
          </div>
          <div><strong>Unité : &nbsp;</strong> {{element.unit || '--'}} &nbsp;&nbsp;</div>
          <div><strong>Quantité Minimale : &nbsp;</strong> {{ element.minquantity || '--' }} &nbsp;&nbsp;</div>
          <div><strong>Marge Minimale : &nbsp;</strong> {{ element.profitmarginpercentage ?
            element.profitmarginpercentage + '%' : '--' }}</div>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
    <tr mat-row *matRowDef="let element; columns: columnsToDisplayWithExpand;" class="example-element-row"
      [class.example-expanded-row]="expandedElement === element"
      (click)="expandedElement = expandedElement === element ? null : element">
    </tr>
    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>

    <!-- <tr mat-header-row *matHeaderRowDef="displayedArticlesColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedArticlesColumns;"></tr> -->

    <!-- Row shown when there is no matching data. -->
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell" colspan="4">Cet article n'existe pas "{{input.value}}"</td>
    </tr>
  </table>

  <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" aria-label="Selectionner les articles"></mat-paginator>
</div>

<div *ngIf="selectedArticle">
  <mat-card class="card-details" [formGroup]="selectedArticleForm">
    <div>
      <mat-dialog-content>
        <h6>{{edit_article}}</h6>
        <div class="half-width-wrapper">
          <!-- Code Article -->
          <mat-form-field class="half-width">
            <mat-label>{{code_article}}</mat-label>
            <input type="text" matInput formControlName="articlecode" placeholder={{article_code}} />
            <mat-icon matSuffix>code</mat-icon>
          </mat-form-field>

          <!-- Libellé -->
          <mat-form-field class="half-width">
            <mat-label>{{description_label}}</mat-label>
            <input type="text" matInput formControlName="description" placeholder={{article_description}} />
            <mat-icon matSuffix></mat-icon>
          </mat-form-field>
        </div>

        <div class="half-width-wrapper">
          <!-- Catégorie -->
          <mat-form-field class="half-width">
            <mat-label>{{categories_label}}</mat-label>
            <mat-select formControlName="selectedCategory" (selectionChange)="onCategoryChange($event.value)">
              <mat-option *ngFor="let category of categories" [value]="category.id">
                {{ category.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Sous Catégorie -->
          <mat-form-field class="half-width">
            <mat-label>{{under_categories_label}}</mat-label>
            <mat-select formControlName="selectedSubCategory">
              <mat-option *ngFor="let subcategory of filteredSubCategories" [value]="subcategory.id">
                {{ subcategory.description }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-dialog-content>
    </div>

    <div *ngIf="woodId === 1">
      <mat-dialog-content>
        <h6>{{wood_properties_label}}</h6>
        <div class="half-width-wrapper">
          <!-- Thickness Choice -->
          <mat-form-field class="half-width">
            <mat-label>{{thikness_label}}</mat-label>
            <mat-select formControlName="selectedThickness">
              <mat-option *ngFor="let thikness of appvariablesThikness" [value]="thikness.id">
                {{ thikness.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Width Choice -->
          <mat-form-field class="half-width">
            <mat-label>{{width_label}}</mat-label>
            <mat-select formControlName="selectedWidth">
              <mat-option *ngFor="let width of appvariablesWidth" [value]="width.id">
                {{ width.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Lengths Choice -->
        <div class="full-width">
          <label>{{legth_label}}</label>
          <div class="checkbox-container">
            <ng-container *ngFor="let length of appvariablesLength; let i = index">
              <mat-checkbox [checked]="isLengthSelected(length.name)"
                (change)="onLengthSelectionChange($event, length.name)">
                {{ length.name }}
              </mat-checkbox>
              <span *ngIf="i < appvariablesLength.length - 1"> - </span>
            </ng-container>
          </div>
        </div>

      </mat-dialog-content>
    </div>

    <div>
      <mat-dialog-content>
        <h6>{{sales_price_label}}</h6>
        <div class="half-width-wrapper">
          <!-- Prix -->
          <mat-form-field class="half-width">
            <mat-label>{{price_label}}</mat-label>
            <input type="number" formControlName="selectedPriceTTC" matInput placeholder="Ex : 240, 1260.504, ..." />
          </mat-form-field>

          <!-- TVA -->
          <mat-form-field class="half-width">
            <mat-label>{{tva_label}}</mat-label>
            <mat-select formControlName="selectedTva">
              <mat-option *ngFor="let tva of appvariablesTVA" [value]="tva.id">
                {{ tva.value }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Calculated Price and Unit -->
        <div class="half-width-wrapper">
          <mat-form-field class="half-width">
            <mat-label>{{calculated_price_label}}</mat-label>
            <input formControlName="calculatedPriceHT" type="number" matInput readonly />
          </mat-form-field>
          <mat-form-field class="half-width">
            <mat-label>{{quantity_unit}}</mat-label>
            <mat-select formControlName="quantityUnit" [disabled]="isQuantityUnitDisabled">
              <mat-option *ngFor="let unit of quantityUnits" [value]="unit">{{ unit }}</mat-option>
            </mat-select>
          </mat-form-field>

        </div>

        <!-- Min Quantity -->
        <div class="half-width-wrapper">
          <mat-form-field class="half-width">
            <mat-label>{{min_quantity}}</mat-label>
            <input formControlName="minquantity" type="number" matInput placeholder="Ex. 2.52/ 30 / ..." />
          </mat-form-field>
          <!-- Marge Minimale de Profit -->
          <mat-form-field class="half-width">
            <mat-label>{{min_profit_percentage}}</mat-label>
            <input formControlName="profitpercentage" type="number" matInput placeholder="Ex. 8%/ 15% / ..." />
          </mat-form-field>
        </div>
      </mat-dialog-content>

    </div>

    <div class="control-button">
      <mat-dialog-actions>
        <button mat-flat-button color="primary" (click)="saveArticle()"><mat-icon>
            edit
          </mat-icon>
          {{update_button}}</button>
        <!-- <button mat-flat-button color="warn" (click)="cancelEditArticleButton()">{{abort_button}}</button> -->
      </mat-dialog-actions>
    </div>
  </mat-card>
</div>


<!-- Router outlet for adding articles -->
<router-outlet></router-outlet>