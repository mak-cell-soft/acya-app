<div class="modal-header">
    <h2>{{ isBatchMode ? 'Conversion en Facture (Multiples)' : 'Conversion en Facture' }}</h2>
    <button mat-icon-button (click)="onCancel()">
        <mat-icon>close</mat-icon>
    </button>
</div>

<div class="modal-content">
    <div class="summary-section">
        <!-- Single Mode Summary -->
        <div *ngIf="!isBatchMode">
            <p><strong>Client:</strong> {{ documents[0].counterpart.firstname }} {{ documents[0].counterpart.lastname }}
            </p>
            <p><strong>Référence BL:</strong> {{ documents[0].docnumber }}</p>
        </div>

        <!-- Batch Mode Summary & Controls -->
        <div *ngIf="isBatchMode" class="batch-controls">
            <p><strong>Nombre de documents:</strong> {{ documents.length }}</p>

            <div class="documents-list-container">
                <p class="list-label">Documents sélectionnés :</p>
                <div class="documents-list">
                    <span class="doc-chip" *ngFor="let doc of documents">
                        {{ doc.docnumber }}
                    </span>
                </div>
            </div>

            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Rechercher un Client</mat-label>
                <input type="text" matInput [formControl]="searchCustomerControl" [matAutocomplete]="auto"
                    placeholder="Nom, Prénom ou Raison Sociale">
                <mat-autocomplete #auto="matAutocomplete"
                    (optionSelected)="onOptionCustomerSelected($event.option.value)">
                    <mat-option *ngFor="let item of filteredCustomers" [value]="item.id">
                        {{ item.name }} {{item.firstname}} {{ item.lastname}}
                        <small *ngIf="item.description">({{ item.description }})</small>
                    </mat-option>
                </mat-autocomplete>
            </mat-form-field>

            <div *ngIf="selectedCustomer" class="selected-customer-info">
                <strong>Selectionné:</strong> {{ selectedCustomer.firstname }} {{ selectedCustomer.lastname }} {{
                selectedCustomer.name }}
            </div>

            <form [formGroup]="taxeForm">
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Taxe</mat-label>
                    <mat-select formControlName="selectedTaxe">
                        <mat-option *ngFor="let taxe of appvariablesTaxes" [value]="taxe.id">
                            {{ taxe.value }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </form>
        </div>

        <p><strong>Montant Total TTC:</strong> {{ (isBatchMode ? totalTTC : documents[0].total_net_ttc) | number:'1.3-3'
            }}
            TND</p>
    </div>

    <mat-divider></mat-divider>

    <div class="payment-status-section" *ngIf="!isBatchMode">
        <div *ngIf="hasPayment" class="status-success">
            <mat-icon>check_circle</mat-icon>
            <span>Paiement existant détecté.</span>
        </div>

        <div *ngIf="!hasPayment" class="status-warning">
            <mat-icon>warning</mat-icon>
            <span>Aucun paiement associé n'a été trouvé.</span>
            <p>Vous pouvez saisir un paiement maintenant ou continuer la conversion.</p>
            <button mat-stroked-button color="primary" (click)="openPaymentModal()">
                <mat-icon>payment</mat-icon>
                Saisir un Paiement
            </button>
        </div>
    </div>

    <div class="payment-status-section" *ngIf="isBatchMode">
        <div class="status-info">
            <mat-icon>info</mat-icon>
            <span>Mode batch : Le paiement doit être effectué après la conversion.</span>
        </div>
    </div>

    <div class="confirmation-text">
        <p>Voulez-vous transformer ce Bon de Livraison en Facture Client ?</p>
        <p class="note">Le Bon de Livraison original sera marqué comme facturé.</p>
    </div>
</div>

<div class="modal-actions">
    <button mat-button (click)="onCancel()">Annuler</button>
    <button mat-raised-button color="primary" (click)="onConvert()" [disabled]="isConverting">
        <mat-icon *ngIf="!isConverting">transform</mat-icon>
        <mat-spinner *ngIf="isConverting" diameter="20"></mat-spinner>
        <span *ngIf="!isConverting">Convertir</span>
        <span *ngIf="isConverting">Conversion...</span>
    </button>
</div>